get.summary.measures.case.control <-
function(data, rho, d=0){  
  #rho <- rho[1]
  disease <- data$disease
  trt <- data$trt
  trt.effect <- data$trt.effect

  neg <- data$marker.neg
  pos <- 1 - neg

    #proportion marker negative
    p.marker.neg <- mean(neg[disease==1])*rho[3] + mean(neg[disease==0])*(1-rho[3])

    #Average Benefit (B) of no treatment among marker negatives...
 
    #empirical estimate

    B.neg.emp.trt0 <-  ifelse( sum(disease[trt==0 & neg==1])>0, expit( logit(mean(disease[trt==0 & neg==1])) + logit(rho[3]) - logit(mean(disease)) ), 0)
    B.neg.emp.trt1 <-  ifelse( sum(disease[trt==1 & neg==1])>0, expit( logit(mean(disease[trt==1 & neg==1])) + logit(rho[3]) - logit(mean(disease)) ), 0) 

    B.neg.emp <- B.neg.emp.trt1 - B.neg.emp.trt0

    #model based estimate
    n.r   <- sum(disease)
    n.nor <- sum(1-disease)
    #numerator
    B.neg.mod.num <-     (1/n.r)*(rho[3])*ifelse(sum(neg==1 & disease==1)>0, sum(-trt.effect[neg==1 & disease==1]), 0) + 
                     (1/n.nor)*(1-rho[3])*ifelse(sum(neg==1 & disease==0)>0, sum(-trt.effect[neg==1 & disease==0]), 0)
    #denominator
    B.neg.mod.den <-     (1/n.r)*(rho[3])*sum(neg[disease==1]) + 
                     (1/n.nor)*(1-rho[3])*sum(neg[disease==0])

    B.neg.mod <- ifelse(B.neg.mod.den>0, B.neg.mod.num/B.neg.mod.den, 0)
 
    #Average Benefit (B) of treatment among marker positives...
 
    #empirical estimate
    B.pos.emp.trt0 <-  ifelse( sum(disease[trt==0 & pos==1])>0, expit( logit(mean(disease[trt==0 & pos==1])) + logit(rho[3]) - logit(mean(disease)) ), 0)
    B.pos.emp.trt1 <-  ifelse( sum(disease[trt==1 & pos==1])>0, expit( logit(mean(disease[trt==1 & pos==1])) + logit(rho[3]) - logit(mean(disease)) ), 0) 

    B.pos.emp <- B.pos.emp.trt0 - B.pos.emp.trt1

    #model based estimate
    #numerator
    B.pos.mod.num <-     (1/n.r)*(rho[3])*ifelse(sum(pos==1 & disease==1)>0, sum(trt.effect[pos==1 & disease==1]), 0) + 
                     (1/n.nor)*(1-rho[3])*ifelse(sum(pos==1 & disease==0)>0, sum(trt.effect[pos==1 & disease==0]), 0)
    #denominator
    B.pos.mod.den <-     (1/n.r)*(rho[3])*sum(pos[disease==1]) +
                     (1/n.nor)*(1-rho[3])*sum(pos[disease==0])

    B.pos.mod <- ifelse(B.pos.mod.den>0, B.pos.mod.num/B.pos.mod.den, 0)
 
    #Theta
    Theta.emp <- B.neg.emp*p.marker.neg
    Theta.mod <- B.neg.mod*p.marker.neg

    # Variance of Trt Effects
    
      # calculate sample weights 
       n.cc <- length(disease)
       Pr.S <- n.cc/rho[1] # Pr(S=1)
       #wi <- rep(0, length(disease))
       #wi[disease==1] <- rho[1]/(mean(disease ==1)*Pr.S)
       #wi[disease==0] <- (1-rho[1])/(mean(disease==0)*Pr.S)  

       #if(sum(wi > 25) > 0 ) { warning("Warning: there exist sampling weights > 25, Variance Estimate may be unstable")}

     
     Var.Delta = mean((trt.effect[disease==1])^2)*rho[3] + mean((trt.effect[disease==0])^2)*(1-rho[3]) 
                   
                  # mean(trt.effect[disease==1]^2)*rho[3] + mean(trt.effect[disease==0]^2)*(1-rho[3]) - 
                  #(mean(trt.effect[disease==1])*rho[3]   + mean(trt.effect[disease==0])*(1-rho[3]))^2  #sum((wi*(trt.effect- d )^2))/sum(wi)

    #Total Gain (TG)


    delta.F <- get.F.case.control( trt.effect, disease, trt, rho = rho)
    
    ooo <- order(trt.effect)

    s.delta.F <- delta.F[ooo]
    p0 <- ((mean(1-trt[disease==1]))*rho[3])/(1-rho[2])
    p1 <- ((mean(trt[disease==1]))*rho[3])/(rho[2])
    TG <- sum( diff(c(0, s.delta.F))*abs( sort(trt.effect) - (p0 - p1) ))
    
  list(     p.neg = p.marker.neg, 
        B.neg.emp = B.neg.emp,
        B.neg.mod = B.neg.mod, 
        B.pos.emp = B.pos.emp, 
        B.pos.mod = B.pos.mod, 
        Theta.emp = Theta.emp, 
        Theta.mod = Theta.mod, 
        Var.Delta = Var.Delta, 
        TG        = TG
        ) 




  

}
